<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->  
  <head>
    <title></title>

    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Decoupling your Ansible roles - Random stuff</title>
    <meta name="description" content="Long time sysadmin with DevOpsy tendencies
">
    <meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Decoupling your Ansible roles - Random stuff"><meta property="og:site_name" content="Random stuff"><meta property="og:description" content="Long time sysadmin with DevOpsy tendencies"><meta property="og:url" content="//leucos.github.io/decoupling-your-ansible-roles"><meta property="article:published_time" content="2015-06-27T00:00:00+02:00"><meta property="article:author" content="//leucos.github.io/about">
  
    

    

    <link rel="alternate" type="application/rss+xml" href="//leucos.github.io/feed.xml">
    <link rel="shortcut icon" href="//leucos.github.io/favicon.ico">
    <link rel="prefetch" href="//leucos.github.io">
    <link rel="canonical" href="//leucos.github.io/decoupling-your-ansible-roles">
    <link rel="stylesheet" 
    href="//leucos.github.io/assets/css/main.css">

    <link href='http://fonts.googleapis.com/css?family=Ubuntu:300,300italic'  rel='stylesheet' type='text/css'>
    <!-- IE Fixes -->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">a,.post-title a{color:#205081}a:hover{border-bottom-color:#205081}.sidebar{background-color:#205081}.wc-top,.sidebar-toggle:active,#sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#205081}.sidebar a:hover,.sidebar .sidebar-nav a{border-bottom-color:#255d95}.sidebar .sidebar-nav{border-top-color:#255d95}.sidebar .sidebar-nav a.sidebar-nav-item:hover,.sidebar .sidebar-nav a.sidebar-nav-item:focus{background:#23588d}.sidebar .sidebar-nav .sidebar-nav-item.active{background-color:#1d4875}ul.social-media li>a{background-color:#1d4875;border-color:#255d95;border-bottom-color:#255d95 !important}ul.social-media li>a:hover{background-color:#b4d0ec}.btn{border-color:#205081;background:#205081}.btn:hover,.btn:focus{border-color:#1b436d;background:#1b436d}</style>
  </head>
  <body>
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><div class="sidebar" id="sidebar">    <img     src="//leucos.github.io/assets/images/gravatar.jpg"    alt="Random stuff" />    <div class="sidebar-info">      <p>        Long time sysadmin with DevOpsy tendencies      </p>  </div>  <nav class="sidebar-nav">    <a class="sidebar-nav-item"       href="//leucos.github.io/">       Home    </a>                        <a class="sidebar-nav-item "       href="//leucos.github.io/about/ ">      About me    </a>                        <a class="sidebar-nav-item "       href="//leucos.github.io/archive/ ">      Blog Archive    </a>        <a class="sidebar-nav-item"       href="https://github.com/leucos"      target="_blank">      GitHub/Download    </a>  </nav>  <div class="sidebar-info small">     <p>       Copyright &copy; Michel Blanc - 2015       Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>       themed by <a href='https://github.com/gayanvirajith/gaya'>gaya</a>     </p>  </div>  <ul class="social-media">        <li>        <a title="b9m on Twitter"             href="https://twitter.com/b9m"             class="twitter wc-img-replace" target="_blank">Twitter</a>    </li>                       <li>        <a title="leucos on Github"             href="https://github.com/leucos"             class="github wc-img-replace" target="_blank">Github</a>    </li>                 <li>        <a title="Subscribe via RSS"             href="//leucos.github.io/feed.xml"            class="rss wc-img-replace" target="_blank">            RSS        </a>    </li></ul></div>

    <div class="main-wrapper">
      <div class="header">
        <div class="container">
          <div class="header-logo"><a href="//leucos.github.io/"   title="Random stuff">  <img     src="//leucos.github.io/assets/images/logo.png"    alt="Random stuff" /></a></div>
          <div class="header-title">
            <a href="//leucos.github.io/" 
              title="Random stuff"> 
              <h3>Random stuff<small>brain dump on sysadmin & DevOps related topics</small></h3>
            </a>
          </div>        
        </div>  
      </div>
      
      <div class="container content">
          <div class="post">

  

  

  <header class="post-header">
    <h1 class="post-title">Decoupling your Ansible roles</h1>
    <p class="post-meta">
    
    <span class="post-date">
    Jun 27, 2015  
    </span>
    </p>
  </header>

  <article class="post-content">
    <p>Having tightly coupled role is the best way to have a hard time
maintaining roles and playbooks, and live in fear of changing anything
in them.</p>

<p>Here is a journey into role decoupling.</p>

<h2 id="the-problem">The problem</h2>

<p>Let say we have a role (<em>my_app</em>) that depend on <em>php-fpm</em> role. In the php-fpm
role, we want to display errors in HTML output depending on the application
running environment (e.g. always display unless we’re running in production
environment).</p>

<p>The application running environment is available in <code>myapp_environment</code>.</p>

<h2 id="first-idea">First idea</h2>

<p>The first idea that comes to mind is to change the php.ini according to
<code>myapp_environment</code>, like so:</p>

<pre><code>{% if myapp_environment == "production" %}
display_errors = Off
{% else %}
display_errors = On
{% endif %}
</code></pre>

<p>The problem with this approach if that php-fpm role now needs
<code>myapp_environment</code> to be defined, which is quite absurd.</p>

<p>So instead, you could rename the variable <code>environment</code>, and use this in
both roles (<code>myapp</code> and <code>php-fpm</code>). This is better, but not much. The
problem with this approach is that a plain <code>environment</code> variable is not
linked (by it’s name) to any role, and this can lead to great confusion
is it is used and set in many roles or in different places in the
inventory.</p>

<h2 id="another-try">Another try</h2>

<p>So the best way is to have two variables, <code>php_fpm_environment</code>, which is
meaningful, and <code>myapp_environment</code>. But now how can I sync them together ?</p>

<p>One ways is to match them in your inventory, like so :</p>

<pre><code># Somewhere in inventory
myapp_environment = "production"
php_fpm_environment = {{ myapp_environment }}
</code></pre>

<p>However, this has some drawbacks. For instance, we are still talking about
<code>php_fpm_environment</code> and, while not a big deal, it has no php-fpm
meaning per se and it is not obvious what this variable does.</p>

<p>Also, in the <code>php.ini</code> template, we will still have to test against the string
“production” to set <code>display_errors</code>. Testing against a string set somewhere
else is quite dangerous. What is the production name for the app is “live”
instead ? Our php-fpm role is broken now.</p>

<h2 id="some-progress">Some progress</h2>

<p>We could go a better way: let’s call the variable <code>php_fpm_display_error</code> (more
meaningful) and make it a boolean. We now can do this :</p>

<pre><code>{% if php_fpm_display_errors %}
display_errors = On
{% else %}
display_errors = Off
{% endif %}
</code></pre>

<p>and somewhere in inventory:</p>

<pre><code>myapp_environment = "production"
php_fpm_display_errors = {{ myapp_environment == "production" }}
</code></pre>

<h2 id="streamlining-our-solution">Streamlining our solution</h2>

<p>Well, this is better now. But it is not perfect. The inventory is more verbose
than required and handles something that it shouldn’t have to take care
of. It is also quite easy to forget to add it to the inventory and end up
with errors showing in production.</p>

<p>By moving this logic away from the inventory, and directly in the role
dependencies, this configuration setting becomes completely transparent, and we get rid of redundancy. We just have to add the following lines in <code>myapp/meta/main.yml</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">role-php-fpm</span>
    <span class="l-Scalar-Plain">php_fpm_display_errors</span><span class="p-Indicator">:</span> <span class="p-Indicator">{{</span> <span class="nv">myapp_environment == &quot;production&quot;</span> <span class="p-Indicator">}}</span></code></pre></div>

<p>Now, php-fpm role is completely decoupled from myapp role, and the production
setting is completely transparent to the role user. Setting <code>myapp_environment</code>
is enough to have the depending role set variables accordingly. You don’t even
have to be aware of the <code>myapp</code> role dependency. If you swap, let say
nginx/php-fpm for apache/php, you just have to change the role dependency and
have no impact on your inventory. If you want to name your production
environment “live”, you can do so by changing <code>meta/main.yml</code> and not
touching anything else.</p>

<p>Keeping role decoupled is the best way to have manageable and reusable
roles. Try to make them self sufficient, and avoid cross variables or
even worse, group names in roles !</p>
    
  </article>

  
    <div class="related-posts">
      <h4>Related Posts</h4>
      <ul>
        
          <li>
            <h5>
              <a href="//leucos.github.io/2015/05/26/transparent-vault-revisited/">
                Transparent encryption with ansible vault revisited
                <small>26 May 2015</small>
              </a>
            </h5>
          </li>
        
          <li>
            <h5>
              <a href="//leucos.github.io/2015/05/25/ansible-transparent-vault/">
                Transparent encryption/decryption with ansible vault
                <small>25 May 2015</small>
              </a>
            </h5>
          </li>
        
          <li>
            <h5>
              <a href="//leucos.github.io/2015/05/03/ansible-contract-inventory/">
                Making dynamic inventory usable with Ansible and Digital Ocean
                <small>03 May 2015</small>
              </a>
            </h5>
          </li>
        
      </ul>
    </div>
  

  <div class="author-info">
    
      <div class="author">   <a href="//leucos.github.io/about">    <img       src="//leucos.github.io/assets/images/gravatar.jpg"      alt="Random stuff" width="60" height="60" />  </a>    <h5>Author</h4>  <h6>    <a href="//leucos.github.io/about">      Michel blanc    </a>  </h5>  <p>    Find me on            <a title="b9m on Twitter"             href="https://twitter.com/b9m"             class="twitter" target="_blank">Twitter</a>               </p></div>

    
  
    
      <div class="share-buttons">  <h5>Share this post on</h5>  <ul class="social-media">    <li>        <a title="b9m on Twitter"           href="https://twitter.com/intent/tweet?original_referer=//leucos.github.io/decoupling-your-ansible-roles&amp;text=Decoupling your Ansible roles&amp;url=//leucos.github.io/decoupling-your-ansible-roles" class="twitter wc-img-replace" target="_blank">          Twitter        </a>    </li>       <li>        <a title=" on Google Plus"             href="https://plus.google.com/share?url=//leucos.github.io/decoupling-your-ansible-roles"             class="google wc-img-replace" target="_blank">Google</a>    </li>    <li>        <a title=" on Facebook"             href="https://www.facebook.com/sharer/sharer.php?u=//leucos.github.io/decoupling-your-ansible-roles&amp;t=Decoupling your Ansible roles"             class="facebook wc-img-replace" target="_blank">Facebook</a>    </li>  </ul></div>
      
  </div>
  
  
</div>

      </div>
      <a href="#0" class="wc-top">Top</a>
      
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle">
      <span></span>
    </label>

    <script type="text/javascript">
      var config = {
        "browser_warning_page": "//leucos.github.io/browser-warning/",
        "disqus_shortname": "randomstuffonrandomstuff"
      };
      /* Browser support detection */
      var browserSupport = (function(){
        var htmlElemClasses = document.querySelector('html').className.split(' ');
        for ( var i = 0; i < htmlElemClasses.length; i += 1 ){
          var className = htmlElemClasses[i];
          if ( className === 'lt-ie9' ){
            return true;
          }
        }
      }());

      if (browserSupport){
        window.location="//leucos.github.io/browser-warning/";
      }

      /* To avoid render blocking css */
      var cb = function() {
        var l = document.createElement('link'); l.rel = 'stylesheet';
        l.href = 'http://fonts.googleapis.com/css?family=PT+Sans';
        var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(cb);
      else window.addEventListener('load', cb);


    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script async type="text/javascript" src="//leucos.github.io/assets/js/gaya.min.js"></script>
    
    
    
<script type="text/javascript">var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-60810209-1']);_gaq.push(['_trackPageview']);(function() {var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);})();</script>
   
  </body>
</html>
