<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Decoupling your Ansible roles &#8211; Random stuff</title>
<meta name="description" content="Stay sane, decouple your Ansible roles">
<meta name="keywords" content="ansible">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Decoupling your Ansible roles">
<meta name="twitter:description" content="Stay sane, decouple your Ansible roles">
<meta name="twitter:site" content="@b9m">
<meta name="twitter:creator" content="@b9m">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://leucos.github.io/images/2015-06-27-decoupling-your-ansible-roles.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Decoupling your Ansible roles">
<meta property="og:description" content="Stay sane, decouple your Ansible roles">
<meta property="og:url" content="https://leucos.github.io/decoupling-your-ansible-roles">
<meta property="og:site_name" content="Random stuff">





<link rel="canonical" href="https://leucos.github.io/decoupling-your-ansible-roles">
<link href="https://leucos.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Random stuff Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://leucos.github.io/assets/css/main.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://leucos.github.io/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://leucos.github.io/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="https://leucos.github.io/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://leucos.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://leucos.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://leucos.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://leucos.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://leucos.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leucos.github.io/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="https://leucos.github.io/" >Home</a></li>
		  
		    
		        
		    
		    <li><a href="https://leucos.github.io/articles/" >Articles</a></li>
		  
		    
		        
		    
		    <li><a href="https://leucos.github.io/tags/" >Tags</a></li>
		  
		    
		        
		    
		    <li><a href="https://leucos.github.io/search/" >Search</a></li>
		  
		    
		        
		    
		    <li><a href="https://leucos.github.io/about/" >About</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	
		<div class="wrap">
			<a href="https://leucos.github.io/" class="site-logo" rel="home" title="Random stuff"><img src="https://leucos.github.io/images/logo.png" width="200" height="200" alt="Random stuff logo" class="animated fadeInDown"></a>
		</div>
	
</header><!-- /.masthead -->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    <img src="https://leucos.github.io/images/posts/2015-06-27-decoupling-your-ansible-roles.jpg" class="entry-feature-image" alt="Decoupling your Ansible roles" ><p class="image-credit">Image credit: <a href="https://pixabay.com/fr/users/VitaminaMov-852074/">VitaminaMov</a></p>
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="https://leucos.github.io/tags/#ansible" title="Pages tagged ansible">ansible</a></span>
        
          <h1 class="entry-title">Decoupling your Ansible roles</h1>
        
      </header>
      <footer class="entry-meta">
        
        
        
          <img src="https://leucos.github.io/images/gravatar.jpg" class="bio-photo" alt="Michel Blanc bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Michel Blanc</span></span>
        <span class="entry-date date published"><time datetime="2015-06-27T00:00:00+02:00"><i class="fa fa-calendar-o"></i> June 27, 2015</time></span>
        
        
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=ansible&amp;text=Decoupling%20your%20Ansible%20roles&amp;url=https://leucos.github.io/decoupling-your-ansible-roles&amp;via=b9m" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://leucos.github.io/decoupling-your-ansible-roles" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=https://leucos.github.io/decoupling-your-ansible-roles" title="Share on Google Plus" itemprop="GooglePlus" target="_blank"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>Having tightly coupled role is the best way to have a hard time
maintaining roles and playbooks, and live in fear of changing anything
in them.</p>

<p>Here is a journey into role decoupling.</p>

<h2 id="the-problem">The problem</h2>

<p>Let say we have a role (<em>my_app</em>) that depend on <em>php-fpm</em> role. In the php-fpm
role, we want to display errors in HTML output depending on the application
running environment (e.g. always display unless we’re running in production
environment).</p>

<p>The application running environment is available in <code>myapp_environment</code>.</p>

<h2 id="first-idea">First idea</h2>

<p>The first idea that comes to mind is to change the php.ini according to
<code>myapp_environment</code>, like so:</p>

<div class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="cp">{%</span> <span class="k">if</span> <span class="nv">myapp_environment</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">display_errors = Off</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">display_errors = On</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span></code></pre></div>

<p>The problem with this approach if that php-fpm role now needs
<code>myapp_environment</code> to be defined, which is quite absurd.</p>

<p>So instead, you could rename the variable <code>environment</code>, and use this in
both roles (<code>myapp</code> and <code>php-fpm</code>). This is better, but not much. The
problem with this approach is that a plain <code>environment</code> variable is not
linked (by it’s name) to any role, and this can lead to great confusion
is it is used and set in many roles or in different places in the
inventory.</p>

<h2 id="another-try">Another try</h2>

<p>So the best way is to have two variables, <code>php_fpm_environment</code> and <code>myapp_environment</code> which makes is meaningful. But now how can I sync
them together ?</p>

<p>One ways is to match them in your inventory, like so :</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># Somewhere in inventory</span>
<span class="l-Scalar-Plain">myapp_environment</span><span class="p-Indicator">:</span> <span class="s">&quot;production&quot;</span>
<span class="l-Scalar-Plain">php_fpm_environment</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">myapp_environment</span><span class="nv"> </span><span class="s">}}&quot;</span></code></pre></div>

<p>However, this has some drawbacks. For instance, we are still talking about
<code>php_fpm_environment</code> and, while not a big deal, it has no php-fpm
meaning per se and it is not obvious what this variable does.</p>

<p>Also, in the <code>php.ini</code> template, we will still have to test against the string
“production” to set <code>display_errors</code>. Testing against a string set somewhere
else is quite dangerous. What is the production name for the app is “live”
instead ? Our php-fpm role is broken now.</p>

<h2 id="some-progress">Some progress</h2>

<p>We could go a better way: let’s call the variable <code>php_fpm_display_error</code> (more
meaningful) and make it a boolean. We now can do this :</p>

<div class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="cp">{%</span> <span class="k">if</span> <span class="nv">php_fpm_display_errors</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">display_errors = On</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">display_errors = Off</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span></code></pre></div>

<p>and somewhere in inventory:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">myapp_environment</span><span class="p-Indicator">:</span> <span class="s">&quot;production&quot;</span>
<span class="l-Scalar-Plain">php_fpm_display_errors</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">myapp_environment</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;production&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span></code></pre></div>

<h2 id="streamlining-our-solution">Streamlining our solution</h2>

<p>Well, this is better now. But it is not perfect. The inventory is more verbose
than required and handles something that it shouldn’t have to take care
of. It is also quite easy to forget to add it to the inventory and end up
with errors showing in production.</p>

<p>By moving this logic away from the inventory, and directly in the role
dependencies, this configuration setting becomes completely transparent, and we get rid of redundancy. We just have to add the following lines in <code>myapp/meta/main.yml</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">role-php-fpm</span>
    <span class="l-Scalar-Plain">php_fpm_display_errors</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">myapp_environment</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&#39;production&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span></code></pre></div>

<p>Now, php-fpm role is completely decoupled from myapp role, and the production
setting is completely transparent to the role user. Setting <code>myapp_environment</code>
is enough to have the depending role set variables accordingly. You don’t even
have to be aware of the <code>myapp</code> role dependency. If you swap, let say
nginx/php-fpm for apache/php, you just have to change the role dependency and
have no impact on your inventory. If you want to name your production
environment “live”, you can do so by changing <code>meta/main.yml</code> and not
touching anything else.</p>

<p>Keeping role decoupled is the best way to have manageable and reusable
roles. Try to make them self sufficient, and avoid cross variables or
even worse, group names in roles !</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="https://leucos.github.io/articles/transparent-vault-revisited/" class="btn" title="Transparent encryption with ansible vault revisited">Previous</a>
      
      
        <a href="https://leucos.github.io/ansible-files-layout" class="btn" title="Laying out roles, inventories and playbooks">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2016 Michel Blanc. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mmistakes.github.io/so-simple-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/b9m" title="Michel Blanc on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/michelblanc" title="Michel Blanc on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/467722/leucos" title="Michel Blanc on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	
	
	<a href="http://github.com/leucos" title="Michel Blanc on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="https://leucos.github.io/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'https://leucos.github.io';
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://leucos.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://leucos.github.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-60810209-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<!-- SC RUM -->
<script type="text/javascript">var SC_RumID = 1701;</script><script type="text/javascript" async src="https://www.statuscake.com/App/RUM/embed.js"></script>


</body>
</html>
